<html lang="fr">
	<head>
		<title>CRUD avec Express + MongoDB</title>
		<script src="js/crudAvecFetchAvecTable.js"></script>
		
		<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/1.0.26/vue.min.js"></script>
		<link rel="stylesheet" href="css/styles.css">
	</head>
	<body>
		<h1>Test de l'API sur le serveur de restaurants</h1>
		<h2>HTTP GET pour obtenir des restaurants, ou un seul<h2>
			<h3>GET /api/restaurants</h3>
			<p>Pour tester sans Ajax, on peut juste faire un lien HTML:</p>
			<ul>
				<li><a href="/api/restaurants">Cliquer pour obtenir les 10 premiers restaurants</a>. La requête est simplement un GET sur <code>/api/restaurants</code></li>
				<p>
				<li><a href="/api/restaurants?page=2">Requête avec pagination, on indique la page (par defaut: 10 restaurants par page)</a>. Ici un GET sur <code>/api/restaurants?page=2</code></li>
				<p>
				<li><a href="/api/restaurants?page=2&pagesize=20">Requête avec pagination, on indique la page (2) et le nombre de restaurants par page (20)</a>. Ici un GET sur <code>/api/restaurants?page=2&pagesize=20</code></li>
				<p>
				<li><a href="/api/restaurants/56b9f89be0adc7f00f348cf6">Requête pour obtenir le détail du restaurant avec id=56b9f89be0adc7f00f348cf6</a>. Ici un GET sur <code>/api/restaurants/2</code></li>
			</ul>
			<p>Pour tester avec Ajax, il faut du JavaScript. On utilise la nouvelle API fetch, disponible depuis 2012. Mais avec un polyfill on peut la faire fonctionner sur tous les navigateurs, même les plus anciens.<p>
			<p><strong>Réponse Ajax du serveur:</strong></p>
			<div id="reponseGET" class="response"></div>

			<ul>
				<li>GET en fetch/Ajax correspondant à la première requête de l'exemple précédent: <button onclick="getRequest1();">Clicker</button></li>
				<p></p>
				<li>GET en fetch/Ajax correspondant à la seconde requête de l'exemple précédent: <button onclick="getRequest2();">Clicker</button></li>
				<p></p>
				<li>GET en fetch/Ajax correspondant à la troisème requête de l'exemple précédent: <button onclick="getRequest3();">Clicker</button></li>
				<p></p>
				<li>GET en fetch/Ajax correspondant à la quatrième requête de l'exemple précédent: <button onclick="getRequest4();">Clicker</button></li>
				<p></p>
				<li>GET COUNT: <button onclick="getRequest5();">Clicker</button></li>
			</ul>
			<h2>GET BY NAME</h2>
			<p><strong>Réponse Ajax du serveur:</strong></p>
			<div id="reponseGETBYNAME" class="response"></div>
			<form onsubmit="getByNameRequest(event);">
				<fieldset>
					<legend>Recherche par nom d'un restaurant</legend>
					<label>
						Nom: <input type="text" name="nom"
						value="Sushis" required placeholder="Michel's restaurant">
					</label>
					<button>Rechercher ce restaurant</button>
				</fieldset>
			</form>
			<h2>HTTP POST pour insérer un restaurant</h2>
			<p>Avec fetch/Ajax POST<p>
			<p><strong>Réponse Ajax du serveur:</strong></p>
			<div id="reponsePOST" class="response"></div>
			<form onsubmit="postRequest(event);">
				<fieldset>
					<legend>Ajout d'un restaurant</legend>
					<label>
						Nom: <input type="text" name="nom"
						value="Sushis de rabat" required placeholder="Michel's restaurant">
					</label>
					<p></p>
					<label>
						Cuisine: <input type="text" name="cuisine" value="Japonais/Marocaine" required placeholder="Cuisine française">
					</label>
					<p></p>
					<button>Ajouter ce restaurant</button>
				</fieldset>
			</form>

			<h2>HTTP PUT pour modifier un restaurant</h2>
			<p>Avec fetch/Ajax PUT<p>
			<p><strong>Réponse Ajax du serveur:</strong></p>
			<div id="reponsePUT" class="response"></div>
			<form id="formulaireModification" onsubmit="putRequest(event);">
				<fieldset>
					<legend>Modification d'un restaurant</legend>
					<label>
						Id: <input type="text" name="_id"
						value="56b9f89be0adc7f00f348cf6" required placeholder="Id du restaurant à modifier">
					</label>
					<p></p>
					<label>
						Nom: <input type="text" name="nom"
						value="Sushis de rabat" required placeholder="Michel's restaurant">
					</label>
					<p></p>
					<label>
						Cuisine: <input type="text" name="cuisine" value="Japonais/Marocaine" required placeholder="Cuisine française">
					</label>
					<p></p>
					<button>Modifier ce restaurant</button>
				</fieldset>
			</form>

			<h2>HTTP DELETE pour Supprimer un restaurant</h2>
			<p>Avec fetch/Ajax DELETE<p>
			<p><strong>Réponse Ajax du serveur:</strong></p>
			<div id="reponseDELETE" class="response"></div>
			<form onsubmit="deleteRequest(event);">
				<fieldset>
					<legend>Suppression d'un restaurant</legend>
					<label>
						Id: <input type="text" name="_id"
						value="56b9f89be0adc7f00f348cf6" required placeholder="Id du restaurant à modifier">
					</label>

					<button>Supprimer ce restaurant</button>
				</fieldset>
			</form>
<script type="text/x-template" id="grid-template">
  <table>
    <thead>
      <tr>
        <th v-for="key in columns"
          @click="sortBy(key)"
          :class="{ active: sortKey == key }">
          {{ key | capitalize }}
          <span class="arrow" :class="sortOrders[key] > 0 ? 'asc' : 'dsc'">
          </span>
        </th>
      </tr>
    </thead>
    <tbody>
      <tr v-for="entry in filteredData">
        <td v-for="key in columns">
          {{entry[key]}}
        </td>
      </tr>
    </tbody>
  </table>
</script>

<!-- demo root element -->
<center>
<div id="demo">

  <demo-grid
    :data="gridData"
    :columns="gridColumns"
    :filter-key="searchQuery">
  </demo-grid>
</div>
</center>
<script>
// register the grid component
Vue.component('demo-grid', {
  template: '#grid-template',
  props: {
    data: Array,
    columns: Array,
    filterKey: String
  },
  data: function () {
    var sortOrders = {}
    this.columns.forEach(function (key) {
      sortOrders[key] = 1
    })
    return {
      sortKey: '',
      sortOrders: sortOrders
    }
  },
  computed: {
    filteredData: function () {
      var sortKey = this.sortKey
      var filterKey = this.filterKey && this.filterKey.toLowerCase()
      var order = this.sortOrders[sortKey] || 1
      var data = this.data
      if (filterKey) {
        data = data.filter(function (row) {
          return Object.keys(row).some(function (key) {
            return String(row[key]).toLowerCase().indexOf(filterKey) > -1
          })
        })
      }
      if (sortKey) {
        data = data.slice().sort(function (a, b) {
          a = a[sortKey]
          b = b[sortKey]
          return (a === b ? 0 : a > b ? 1 : -1) * order
        })
      }
      return data
    }
  },
  filters: {
    capitalize: function (str) {
      return str.charAt(0).toUpperCase() + str.slice(1)
    }
  },
  methods: {
    sortBy: function (key) {
      this.sortKey = key
      this.sortOrders[key] = this.sortOrders[key] * -1
    }
  }
})
let url = "/api/restaurants";
fetch(url)
    .then(function(responseJSON) {
        responseJSON.json()
        .then(function(res) {
            // Maintenant res est un vrai objet JavaScript
            remplirDonnee(res);
        });
    })
    .catch(function (err) {
        	console.log(err);
    });

function remplirDonnee(reponse){
	afficherTable(reponse.data);
}

function afficherTable(restaurants){
	console.log("creer table vue.js");
	var gridDataFull = [];
	console.log(restaurants.length);
	for(var i=0; i < restaurants.length; i++) {
		let restaurant = restaurants[i];
        let id = restaurant._id;
        let nom = restaurant.name;
        let restcuisine = restaurant.cuisine;
        gridDataFull.push({ restaurant_id: id, name: nom, cuisine: restcuisine });
	}

// bootstrap the demo
	var demo = new Vue({
		el: '#demo',
	  	data: {
	    	searchQuery: '',
	    	gridColumns: ['restaurant_id', 'name', 'cuisine'],
	    	gridData: gridDataFull //[
	      		//{ name: 'Chuck Norris', power: Infinity },
	      		//{ name: 'Bruce Lee', power: 9000 },
	      		//{ name: 'Jackie Chan', power: 7000 },
	      		//{ name: 'Jet Li', power: 8000 }
	    	//]	
	  	}
	})

}


</script>
	</body>
</html>
